name: Docker Build and Push

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Maven ç¼–è¯‘å’Œæµ‹è¯•
      run: |
        # æ£€æŸ¥é¡¹ç›®ç»“æ„
        echo "ğŸ“ é¡¹ç›®ç»“æ„:"
        ls -la
        echo ""
        echo "ğŸ“‹ å­æ¨¡å—:"
        ls -la */pom.xml 2>/dev/null || echo "æ— å­æ¨¡å—"
        echo ""
        
        # ç¼–è¯‘å’Œæµ‹è¯•
        mvn clean compile -B -DskipTests=false
        echo "âœ… Maven ç¼–è¯‘å®Œæˆ"

    - name: Maven æ‰“åŒ…
      run: |
        # ä¸ºå¤šæ¨¡å—é¡¹ç›®æ‰“åŒ…
        if [ -f "user-service/pom.xml" ]; then
          echo "ğŸ“¦ æ£€æµ‹åˆ°å¤šæ¨¡å—é¡¹ç›®ï¼Œæ‰“åŒ…æ‰€æœ‰å­æ¨¡å—"
          mvn package -B -DskipTests=true -pl user-service,product-service,gateway-service
        else
          echo "ğŸ“¦ å•æ¨¡å—é¡¹ç›®æ‰“åŒ…"
          mvn package -B -DskipTests=true
        fi
        echo "âœ… Maven æ‰“åŒ…å®Œæˆ"

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ° GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: é•œåƒå®‰å…¨æ‰«æ
      if: github.event_name != 'pull_request'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      if: github.event_name != 'pull_request'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  # å¾®æœåŠ¡æ„å»ºä»»åŠ¡
  build-microservices:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [user-service, product-service, gateway-service]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ç¼–è¯‘ ${{ matrix.service }}
      run: |
        # ä»æ ¹ç›®å½•ç¼–è¯‘æŒ‡å®šæ¨¡å—ï¼ˆä¸æœ¬åœ°æ„å»ºæ–¹å¼ä¸€è‡´ï¼‰
        mvn clean package -B -DskipTests=true -pl ${{ matrix.service }}
        echo "âœ… ${{ matrix.service }} ç¼–è¯‘å®Œæˆ"

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ° GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=sha,prefix={{branch}}-

    - name: æ„å»ºå’Œæ¨é€ ${{ matrix.service }} é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .  # âœ… ä¿®å¤ï¼šä»æ ¹ç›®å½•æ„å»ºï¼ˆä¸æœ¬åœ°æ„å»ºæ–¹å¼ä¸€è‡´ï¼‰
        file: ./${{ matrix.service }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # éƒ¨ç½²é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [build, build-microservices]
    if: always() && github.event_name != 'pull_request'
    
    steps:
    - name: å‘é€æ„å»ºé€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ Docker é•œåƒæ„å»ºå®Œæˆ
          ğŸ“¦ ä»“åº“: ${{ github.repository }}
          ğŸŒŸ åˆ†æ”¯: ${{ github.ref }}
          ğŸ“ æäº¤: ${{ github.sha }}
          ğŸ”— é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}